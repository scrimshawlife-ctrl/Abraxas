{% extends "base.html" %}
{% block content %}
<h1>Compare {{ left.run_id }} vs {{ right.run_id }}</h1>
<p><a href="/runs/{{ left.run_id }}">left run</a> 路 <a href="/runs/{{ right.run_id }}">right run</a></p>

{% if compare.lineage_note %}
  <div class="card warn">
    <b>Lineage note:</b> {{ compare.lineage_note }}
  </div>
{% endif %}

<div class="card" style="margin-top:12px;">
  <h2>Meta Diffs</h2>
  <table>
    <tr><th align="left">field</th><th align="left">left</th><th align="left">right</th></tr>
    <tr><td>tier</td><td>{{ compare.meta.left.tier }}</td><td>{{ compare.meta.right.tier }}</td></tr>
    <tr><td>lane</td><td>{{ compare.meta.left.lane }}</td><td>{{ compare.meta.right.lane }}</td></tr>
    <tr><td>invariance_status</td><td>{{ compare.meta.left.invariance_status }}</td><td>{{ compare.meta.right.invariance_status }}</td></tr>
    <tr><td>provenance_status</td><td>{{ compare.meta.left.provenance_status }}</td><td>{{ compare.meta.right.provenance_status }}</td></tr>
    <tr><td>drift_flags</td><td>{{ compare.meta.left.drift_flags }}</td><td>{{ compare.meta.right.drift_flags }}</td></tr>
  </table>
</div>

<div class="card" style="margin-top:12px;">
  <h2>Pause Diffs</h2>
  <table>
    <tr><th align="left">field</th><th align="left">left</th><th align="left">right</th></tr>
    <tr><td>pause_required</td><td>{{ compare.pause.left.pause_required }}</td><td>{{ compare.pause.right.pause_required }}</td></tr>
    <tr><td>pause_reason</td><td>{{ compare.pause.left.pause_reason }}</td><td>{{ compare.pause.right.pause_reason }}</td></tr>
  </table>
</div>

<div class="card" style="margin-top:12px;">
  <h2>Policy Drift</h2>
  <p><b>Current policy hash:</b> {{ current_policy_hash[:12] if current_policy_hash else "n/a" }}</p>
  <table>
    <tr><th align="left">side</th><th align="left">ingest hash</th><th align="left">match current</th></tr>
    <tr>
      <td>left</td>
      <td>{{ left_ingest_policy_hash[:12] if left_ingest_policy_hash else "n/a" }}</td>
      <td>{{ left_policy_match if left_policy_match is not none else "unknown" }}</td>
    </tr>
    <tr>
      <td>right</td>
      <td>{{ right_ingest_policy_hash[:12] if right_ingest_policy_hash else "n/a" }}</td>
      <td>{{ right_policy_match if right_policy_match is not none else "unknown" }}</td>
    </tr>
  </table>
  {% if ingest_policy_diff %}
    <p><b>Ingest policy differed between runs.</b></p>
  {% endif %}
</div>

{% if compare.oracle and (compare.oracle.present_left or compare.oracle.present_right) %}
  <div class="card" style="margin-top:12px;">
    <h2>Oracle (OSLv2) Diffs</h2>
    <p><b>Present:</b> left={{ compare.oracle.present_left }} 路 right={{ compare.oracle.present_right }}</p>

    <h3>Provenance</h3>
    <table>
      <tr><th align="left">field</th><th align="left">left</th><th align="left">right</th><th align="left">changed</th></tr>
      <tr>
        <td>input_hash</td>
        <td>{{ compare.oracle.provenance_diffs.input_hash.left }}</td>
        <td>{{ compare.oracle.provenance_diffs.input_hash.right }}</td>
        <td>{{ compare.oracle.provenance_diffs.input_hash.changed }}</td>
      </tr>
      <tr>
        <td>policy_hash</td>
        <td>{{ compare.oracle.provenance_diffs.policy_hash.left }}</td>
        <td>{{ compare.oracle.provenance_diffs.policy_hash.right }}</td>
        <td>{{ compare.oracle.provenance_diffs.policy_hash.changed }}</td>
      </tr>
      <tr>
        <td>stability_status</td>
        <td>{{ compare.oracle.provenance_diffs.stability_status.left }}</td>
        <td>{{ compare.oracle.provenance_diffs.stability_status.right }}</td>
        <td>{{ compare.oracle.provenance_diffs.stability_status.changed }}</td>
      </tr>
    </table>

    <h3>Flags</h3>
    <h4>Added</h4>
    <ul>
      {% for item in compare.oracle.flags_added[:50] %}
        <li><code>{{ item }}</code></li>
      {% endfor %}
    </ul>
    <h4>Removed</h4>
    <ul>
      {% for item in compare.oracle.flags_removed[:50] %}
        <li><code>{{ item }}</code></li>
      {% endfor %}
    </ul>

    <h3>Evidence</h3>
    <h4>Added</h4>
    <ul>
      {% for item in compare.oracle.evidence_added[:50] %}
        <li><code>{{ item }}</code></li>
      {% endfor %}
    </ul>
    <h4>Removed</h4>
    <ul>
      {% for item in compare.oracle.evidence_removed[:50] %}
        <li><code>{{ item }}</code></li>
      {% endfor %}
    </ul>

    <h3>Indicator Deltas</h3>
    <table>
      <tr><th align="left">path</th><th align="left">left</th><th align="left">right</th><th align="left">delta</th></tr>
      {% for row in compare.oracle.indicator_deltas[:30] %}
        <tr>
          <td><code>{{ row.path }}</code></td>
          <td>{{ row.left }}</td>
          <td>{{ row.right }}</td>
          <td>{{ row.delta }}</td>
        </tr>
      {% endfor %}
    </table>

    <h3>Indicator Changes (non-numeric)</h3>
    <ul>
      {% for row in compare.oracle.indicator_changes[:30] %}
        <li><code>{{ row.path }}</code> 路 left={{ row.left }} 路 right={{ row.right }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

{% if compare.pressure.left or compare.pressure.right %}
  <div class="card" style="margin-top:12px;">
    <h2>Plan Pressure</h2>
    <table>
      <tr><th align="left">side</th><th align="left">score</th><th align="left">components</th></tr>
      <tr><td>left</td><td>{{ compare.pressure.left.score if compare.pressure.left else "" }}</td><td>{{ compare.pressure.left.components if compare.pressure.left else "" }}</td></tr>
      <tr><td>right</td><td>{{ compare.pressure.right.score if compare.pressure.right else "" }}</td><td>{{ compare.pressure.right.components if compare.pressure.right else "" }}</td></tr>
    </table>
  </div>
{% endif %}

<div class="card" style="margin-top:12px;">
  <h2>Extracted Structure Diffs</h2>
  <h3>Added paths</h3>
  <ul>
    {% for path in compare.added_paths[:50] %}
      <li><code>{{ path }}</code></li>
    {% endfor %}
  </ul>
  <h3>Removed paths</h3>
  <ul>
    {% for path in compare.removed_paths[:50] %}
      <li><code>{{ path }}</code></li>
    {% endfor %}
  </ul>
</div>

<div class="card" style="margin-top:12px;">
  <h2>Numeric Metric Deltas</h2>
  <table>
    <tr><th align="left">path</th><th align="left">left</th><th align="left">right</th><th align="left">delta</th></tr>
    {% for row in compare.metric_deltas[:30] %}
      <tr>
        <td><code>{{ row.path }}</code></td>
        <td>{{ row.left }}</td>
        <td>{{ row.right }}</td>
        <td>{{ row.delta }}</td>
      </tr>
    {% endfor %}
  </table>
</div>

<div class="card" style="margin-top:12px;">
  <h2>Unknowns</h2>
  <h3>Added</h3>
  <ul>
    {% for path in compare.unknowns_added[:50] %}
      <li><code>{{ path }}</code></li>
    {% endfor %}
  </ul>
  <h3>Removed</h3>
  <ul>
    {% for path in compare.unknowns_removed[:50] %}
      <li><code>{{ path }}</code></li>
    {% endfor %}
  </ul>
</div>

<div class="card" style="margin-top:12px;">
  <h2>Evidence Refs</h2>
  <h3>Added</h3>
  <ul>
    {% for ref in compare.refs_added[:50] %}
      <li><code>{{ ref }}</code></li>
    {% endfor %}
  </ul>
  <h3>Removed</h3>
  <ul>
    {% for ref in compare.refs_removed[:50] %}
      <li><code>{{ ref }}</code></li>
    {% endfor %}
  </ul>
</div>
{% endblock %}
